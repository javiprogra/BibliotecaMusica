@page "/"
@using Models;

@inject Blazored.LocalStorage.ISyncLocalStorageService localStorage

<h1>Ingreso de Canciones</h1>


<EditForm Model="@cancion" OnValidSubmit="@GuardarCancion">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="container text-center">
        <div class="row mt-3">
            <h2>Canción:</h2>
            <div class="col">
                <p>
                    <label for="identifier" class="form-label">Nombre de la canción: </label>
                    <InputText id="identifier" class="form-control" @bind-Value="cancion.nombre" />
                    <ValidationMessage For="() => cancion.nombre" />
                </p>

                <p>
                    <label for="identifier" class="form-label">Artista: </label>
                    <InputText id="identifier" class="form-control" @bind-Value="cancion.artista" />
                    <ValidationMessage For="() => cancion.artista" />
                </p>

                <p>
                    <label for="identifier" class="form-label">Duración: </label>
                    <InputText id="identifier" class="form-control" @bind-Value="cancion.duracion" />
                    <ValidationMessage For="() => cancion.duracion" />
                </p>


            </div>
            
        </div>
    </div>
    <p>
        <div class="row text-center mt-3">
            <div class="col">
                <button class="btn btn-secondary" type="submit">Guardar canción</button>
            </div>
        </div>
    </p>
</EditForm>


<EditForm Model="@album" OnValidSubmit="@GuardarAlbum">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="container text-center">
        <div class="row mt-3">
            <h2>Albúm:</h2>
            <div class="col">
                <p>
                    <label for="identifier" class="form-label">Nombre de la canción: </label>
                    <InputText id="identifier" class="form-control" @bind-Value="album.tituloAlbum" />
                    <ValidationMessage For="() => album.tituloAlbum" />
                </p>

                <p>
                    <label for="identifier" class="form-label">Artista: </label>
                    <InputText id="identifier" class="form-control" @bind-Value="album.artistaAlbum" />
                    <ValidationMessage For="() => album.artistaAlbum" />
                </p>

                <p>
                    <label for="productionDate">Fecha de publicacióno: </label>
                    <InputDate id="productionDate" class="form-control" @bind-Value="album.fechaPublicacion" />
                    <ValidationMessage For="() => album.fechaPublicacion" />
                </p>

                <div class="row justify-content-center mt-3">
                    @if (cancionesDisponibles.Any())
                    {
                        <h4 class="text-center">Canciones para este álbum:</h4>
                        @foreach (var cancion in cancionesDisponibles)
                        {
                            <div class="col-6 d-flex align-items-center justify-content-start mb-2">
                                <input class="form-check-input me-2" type="checkbox"
                                       checked="@cancionesSeleccionadas.Contains(cancion)"
                                       @onchange="(e) => SeleccionarCancion(e.Value, cancion)" />

                                <label class="form-check-label">
                                    @cancion.nombre - @cancion.artista (@cancion.duracion)
                                </label>
                            </div>
                        }
                    }
                </div>

                

                


            </div>

        </div>
    </div>
    <p>
        <div class="row text-center mt-3">
            <div class="col">
                <button class="btn btn-secondary" type="submit">Guardar canción</button>
            </div>
        </div>
    </p>
</EditForm>

@code {
    private Cancion cancion = new Cancion();
    private List<Cancion> canciones = new List<Cancion>();

    private Album album = new Album();
    private List<Album> albumes = new List<Album>();

    private List<Cancion> cancionesDisponibles = new List<Cancion>();
    private HashSet<Cancion> cancionesSeleccionadas = new(); // Las que el usuario elige

    private void GuardarCancion()
    {
        // Recuperar las canciones que ya estaban guardadas
        canciones = localStorage.GetItem<List<Cancion>>("canciones") ?? new List<Cancion>();
        // Agregar la nueva
        canciones.Add(cancion);
        // Guardar la lista actualizada
        localStorage.SetItem("canciones", canciones);
        // Limpiar el formulario
        cancion = new Cancion();
        // Actualizar la lista disponible para los álbumes
        cancionesDisponibles = canciones;
    }

    private void GuardarAlbum()
    {
        albumes = localStorage.GetItem<List<Album>>("albumes") ?? new List<Album>();

        album.canciones = cancionesSeleccionadas.ToList();
        albumes.Add(album);
        localStorage.SetItem("albumes", albumes);

        // Reset
        album = new Album();
        cancionesSeleccionadas.Clear();
    }

    protected override void OnInitialized()
    {
        // Cargar canciones previamente guardadas
        cancionesDisponibles = localStorage.GetItem<List<Cancion>>("canciones") ?? new List<Cancion>();
    }

    private void SeleccionarCancion(object checkedValue, Cancion cancion)
    {
        bool isChecked = (bool)checkedValue;

        if (isChecked)
            cancionesSeleccionadas.Add(cancion);
        else
            cancionesSeleccionadas.Remove(cancion);
    }
}